<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Rental - User Dashboard</title>
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"> -->
    <link th:href="@{/css/userdashboard.css}" rel="stylesheet" />

</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>User Dashboard</h2>
            </div>
            <ul class="sidebar-menu">
                <li onclick="redirectToCatalog()" class="active">
                    <i class="fas fa-film"></i> Catalog
                </li>
                <li onclick="redirectToRentals()">
                    <i class="fas fa-ticket-alt"></i> Rentals
                </li>
                <li onclick="redirectToHistory()">
                    <i class="fas fa-history"></i> History
                </li>
                <li onclick="redirectToProfile()">
                    <i class="fas fa-user"></i> Profile
                </li>
                <li onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div id="catalogSection" class="section active">
                <!-- Alert Messages -->
                <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                <div class="content-header">
                    <h2>Movie Catalog</h2>
                </div>
                <br>

                <!-- Search and Filter -->
                <div class="search-filter-container">
                    <form class="search-form" method="get" th:action="@{/userdashboard}">
                        <input type="text" name="search" th:value="${search}" class="search-input"
                            placeholder="Search movies...">
                        <button type="submit" class="search-btn">Search</button>
                    </form>
                    <div class="filter-container">
                        <form class="filter-form" method="get" th:action="@{/userdashboard}">
                            <select name="genre" class="genre-select" onchange="this.form.submit()">
                                <option value="">All Genres</option>
                                <option th:each="genre: ${genres}" th:value="${genre}" th:text="${genre}"
                                    th:selected="${genre == selectedGenre}"></option>
                            </select>
                        </form>
                    </div>
                </div>

                <!-- Movie Grid -->
                <div class="movie-grid">
                    <div th:each="movie : ${movies}" class="movie-card">
                        <img th:src="@{'data:image/jpeg;base64,' + ${movie.base64Cover}}" th:alt="${movie.judul}">
                        
                        <div class="movie-card-content">
                            <h3 th:text="${movie.judul}">Movie Title</h3>
                            <p><strong>Genre:</strong> <span th:text="${movie.genre}">Genre</span></p>
                            <p><strong>Actor:</strong> <span th:text="${movie.aktor}">Actor</span></p>
                            <p><strong>Stock:</strong> <span th:text="${movie.stok}">Stock</span></p>
                            <p><strong>Price:</strong>Rp<span th:id="'price-' + ${movie.filmId}"
                                    th:data-price7="${movie.harga7Hari}" th:data-price14="${movie.harga14Hari}"
                                    th:data-price30="${movie.harga30Hari}"
                                    th:text="${#numbers.formatDecimal(movie.harga7Hari, 0, 'COMMA', 0, 'POINT')}">
                                </span>
                            </p>

                            <!-- Rental Form -->
                            <form th:if="${movie.stok > 0}" th:action="@{/rent/{filmId}(filmId=${movie.filmId})}"
                                method="post" class="rental-form">
                                <div class="form-group">
                                    <label for="duration">Rental Duration:</label><br><br>

                                    <select th:id="'duration-' + ${movie.filmId}" name="duration"
                                        th:onchange="'updatePrice(' + ${movie.filmId} + ')'" required>
                                        <option value="7">7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                                <button type="submit" class="rent-btn">Rent Now</button>
                            </form>
                            <p th:if="${movie.stok <= 0}" class="out-of-stock">Out of Stock</p>
                        </div>
                    </div>
                </div>
                <!-- Pagination -->
                <nav th:if="${pageCount > 1}">
                    <ul class="pagination-container">
                        <li>
                            <a th:href="@{/userdashboard(page=${currentPage - 1}, search=${search}, genre=${selectedGenre})}"
                                aria-label="Previous" th:class="${currentPage == 1 ? 'disabled' : null}">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li th:each="i : ${#numbers.sequence(1, pageCount)}">
                            <a th:href="@{/userdashboard(page=${i}, search=${search}, genre=${selectedGenre})}"
                                th:text="${i}" th:class="${currentPage == i ? 'active' : null}"></a>
                        </li>
                        <li>
                            <a th:href="@{/userdashboard(page=${currentPage + 1}, search=${search}, genre=${selectedGenre})}"
                                aria-label="Next" th:class="${currentPage == pageCount ? 'disabled' : null}">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- Update script section -->
                <script>
                    function updatePrice(movieId) {
                        const duration = document.getElementById(`duration-${movieId}`).value;
                        const priceElement = document.getElementById(`price-${movieId}`);

                        const prices = {
                            '7': parseFloat(priceElement.dataset.price7),
                            '14': parseFloat(priceElement.dataset.price14),
                            '30': parseFloat(priceElement.dataset.price30)
                        };

                        const formattedPrice = new Intl.NumberFormat('id-ID').format(prices[duration]);
                        priceElement.textContent = formattedPrice;
                    }

                    // Fungsi-fungsi redirect yang sudah ada
                    function redirectToCatalog() {
                        window.location.href = '/userdashboard';
                    }

                    function redirectToRentals() {
                        window.location.href = '/rental';
                    }

                    function redirectToHistory() {
                        window.location.href = '/history-rental';
                    }

                    function redirectToProfile() {
                        window.location.href = '/profile';
                    }

                    function logout() {
                        window.location.href = '/logout';
                    }
                </script>
</body>

</html>